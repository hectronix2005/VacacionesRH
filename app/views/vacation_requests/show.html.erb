<div class="min-h-screen bg-gray-50 py-6">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
      <nav class="flex" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-4">
          <li>
            <%= link_to "Dashboard", root_path,
                        class: "text-gray-400 hover:text-gray-500" %>
          </li>
          <li>
            <div class="flex items-center">
              <svg class="flex-shrink-0 h-5 w-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
              </svg>
              <%= link_to "Mis Solicitudes", vacation_requests_path,
                          class: "ml-4 text-gray-400 hover:text-gray-500" %>
            </div>
          </li>
          <li>
            <div class="flex items-center">
              <svg class="flex-shrink-0 h-5 w-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
              </svg>
              <span class="ml-4 text-sm font-medium text-gray-500">Solicitud #<%= @vacation_request.id %></span>
            </div>
          </li>
        </ol>
      </nav>

      <div class="mt-4 flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">
            Solicitud de <%= @vacation_request.user.vacation_term.titleize %>
          </h1>
          <p class="mt-1 text-sm text-gray-600">
            <%= @vacation_request.user.full_name %> • Creada <%= time_ago_in_words(@vacation_request.created_at) %> atrás
          </p>
        </div>
        
        <!-- Status Badge -->
        <div>
          <% if @vacation_request.pending? %>
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
              <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
              </svg>
              Pendiente de Aprobación
            </span>
          <% elsif @vacation_request.approved? %>
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-green-100 text-green-800">
              <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              Completamente Aprobada
            </span>
          <% elsif @vacation_request.rejected? %>
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-red-100 text-red-800">
              <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
              Rechazada
            </span>
          <% elsif @vacation_request.taken? %>
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
              <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              Vacaciones Tomadas
            </span>
          <% end %>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Main Content -->
      <div class="lg:col-span-2">
        <!-- Request Details -->
        <div class="bg-white shadow rounded-lg mb-6">
          <div class="px-6 py-5 border-b border-gray-200">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Detalles de la Solicitud</h3>
          </div>
          <div class="px-6 py-5">
            <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
              <div>
                <dt class="text-sm font-medium text-gray-500">Fecha de Inicio</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  <%= @vacation_request.start_date.strftime("%A, %d de %B de %Y") %>
                </dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Fecha de Fin</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  <%= @vacation_request.end_date.strftime("%A, %d de %B de %Y") %>
                </dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Días Solicitados</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                    <%= @vacation_request.days_requested %> días
                  </span>
                </dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Empresa</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                    <%= @vacation_request.company %>
                  </span>
                </dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Tipo</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  <%= @vacation_request.user.vacation_term.titleize %>
                </dd>
              </div>
            </dl>
          </div>
        </div>

        <!-- Approval Progress -->
        <div class="bg-white shadow rounded-lg mb-6">
          <div class="px-6 py-5 border-b border-gray-200">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Progreso de Aprobación</h3>
          </div>
          <div class="px-6 py-5">
            <div class="flex items-center justify-between mb-4">
              <span class="text-sm font-medium text-gray-700">Completado</span>
              <span class="text-sm font-medium text-gray-700"><%= @vacation_request.approval_progress_percentage %>%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: <%= @vacation_request.approval_progress_percentage %>%"></div>
            </div>

            <!-- Approval Steps -->
            <div class="mt-8">
              <nav aria-label="Progress">
                <ol class="flex items-center">
                  <% @vacation_request.approvals_summary.each_with_index do |(role, status), index| %>
                    <li class="<%= 'pr-8 sm:pr-20' if index < @vacation_request.approvals_summary.size - 1 %> relative">
                      <% if status[:completed] %>
                        <!-- Completed step -->
                        <div class="absolute inset-0 flex items-center" aria-hidden="true">
                          <div class="h-0.5 w-full bg-green-600"></div>
                        </div>
                        <a href="#" class="relative w-8 h-8 flex items-center justify-center bg-green-600 rounded-full hover:bg-green-900">
                          <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                          </svg>
                          <span class="sr-only"><%= role.humanize %> completado</span>
                        </a>
                        <div class="mt-2">
                          <span class="text-xs font-medium text-gray-900"><%= I18n.t("users.roles.#{role}", default: role.to_s.humanize) %></span>
                          <div class="text-xs text-gray-500">
                            <%= status[:approver] %>
                            <br>
                            <time><%= status[:approved_at]&.strftime("%d/%m/%Y %H:%M") %></time>
                          </div>
                        </div>
                      <% else %>
                        <!-- Pending step -->
                        <div class="absolute inset-0 flex items-center" aria-hidden="true">
                          <div class="h-0.5 w-full bg-gray-200"></div>
                        </div>
                        <a href="#" class="relative w-8 h-8 flex items-center justify-center bg-white border-2 border-gray-300 rounded-full">
                          <span class="h-2.5 w-2.5 bg-transparent rounded-full" aria-hidden="true"></span>
                          <span class="sr-only"><%= I18n.t("users.roles.#{role}", default: role.to_s.humanize) %> pendiente</span>
                        </a>
                        <div class="mt-2">
                          <span class="text-xs font-medium text-gray-500"><%= I18n.t("users.roles.#{role}", default: role.to_s.humanize) %></span>
                          <div class="text-xs text-gray-400">Pendiente</div>
                        </div>
                      <% end %>
                    </li>
                  <% end %>
                </ol>
              </nav>
            </div>
          </div>
        </div>

        <!-- Comments/History -->
        <% if @vacation_request.vacation_approvals.approved.any? %>
          <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-5 border-b border-gray-200">
              <h3 class="text-lg leading-6 font-medium text-gray-900">Historial de Aprobaciones</h3>
            </div>
            <div class="px-6 py-5">
              <div class="flow-root">
                <ul class="-mb-8">
                  <% @vacation_request.vacation_approvals.approved.each_with_index do |approval, index| %>
                    <li>
                      <div class="relative pb-8">
                        <% unless index == @vacation_request.vacation_approvals.count - 1 %>
                          <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>
                        <% end %>
                        <div class="relative flex space-x-3">
                          <div>
                            <span class="h-8 w-8 rounded-full bg-green-500 flex items-center justify-center ring-8 ring-white">
                              <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                              </svg>
                            </span>
                          </div>
                          <div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4">
                            <div>
                              <p class="text-sm text-gray-500">
                                Aprobado por <span class="font-medium text-gray-900"><%= approval.user.full_name %></span>
                                (<%= approval.role_display_name %>)
                              </p>
                              <% if approval.comments.present? %>
                                <div class="mt-2 text-sm text-gray-700">
                                  <p>"<%= approval.comments %>"</p>
                                </div>
                              <% end %>
                            </div>
                            <div class="text-right text-sm whitespace-nowrap text-gray-500">
                              <time><%= approval.approved_at %></time>
                            </div>
                          </div>
                        </div>
                      </div>
                    </li>
                  <% end %>
                </ul>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Sidebar -->
      <div class="lg:col-span-1">
        <!-- Actions -->
        <div class="bg-white shadow rounded-lg mb-6">
          <div class="px-6 py-5 border-b border-gray-200">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Acciones</h3>
          </div>
          <div class="px-6 py-5">
            <div class="space-y-3">
              <!-- Botón de exportación PDF -->
              <%= link_to export_pdf_vacation_request_path(@vacation_request, format: :pdf),
                          class: "w-full flex justify-center items-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",
                          title: "Descargar solicitud en PDF" do %>
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Exportar PDF
              <% end %>

              <%= link_to "Editar", edit_vacation_request_path(@vacation_request),
                          class: "w-full flex justify-center py-2 px-4 border border-green-300 rounded-md shadow-sm bg-green-50 text-sm font-medium text-black-700 hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" %>

              <!-- Employee actions -->
              <% if @vacation_request.user == current_user && @vacation_request.pending? %>
                <%= link_to "Cancelar Solicitud", vacation_request_path(@vacation_request),
                            method: :delete,
                            confirm: "¿Estás seguro de que quieres cancelar esta solicitud?",
                            class: "w-full flex justify-center py-2 px-4 border border-red-300 rounded-md shadow-sm bg-white text-sm font-medium text-red-700 hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" %>
              <% end %>

              <!-- Leader/HR approval actions -->
              <% if @vacation_request.can_be_approved_by?(current_user) %>
                <div class="bg-gray-50 rounded-lg p-4">
                  <%= form_with url: approve_vacation_request_path(@vacation_request), method: :patch, local: true do |form| %>
                    <%= form.text_area :comments, 
                                      placeholder: "Comentarios de aprobación (opcional)", 
                                      rows: 3,
                                      class: "w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm mb-3" %>
                    <%= form.submit "Aprobar",
                                    class: "w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm bg-green-600 text-sm font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" %>
                  <% end %>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                  <%= form_with url: reject_vacation_request_path(@vacation_request), method: :patch, local: true do |form| %>
                    <%= form.text_area :reason, 
                                      placeholder: "Motivo del rechazo (requerido)", 
                                      rows: 3,
                                      required: true,
                                      class: "w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm mb-3" %>
                    <%= form.submit "Rechazar",
                                    class: "w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm bg-red-600 text-sm font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" %>
                  <% end %>
                </div>
              <% end %>

              <!-- HR mark as taken -->
              <% if current_user.can_taken_requests? && @vacation_request.approved? && !@vacation_request.taken? %>
                <%= link_to "Marcar como Tomada", mark_as_taken_vacation_request_path(@vacation_request),
                            data: {
                              turbo_method: :patch,
                              turbo_confirm: "¿Confirmas que estas vacaciones ya han sido tomadas?",
                            },
                            class: "w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm bg-indigo-600 text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
              <% end %>

              <!-- Back button -->
              <% if current_user.can_approve_requests? %>
                <%= link_to "← Volver a Pendientes", pending_vacation_requests_path,
                            class: "w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
              <% else %>
                <%= link_to "← Volver a Mis Solicitudes", vacation_requests_path,
                            class: "w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Request Info -->
        <div class="bg-white shadow rounded-lg">
          <div class="px-6 py-5 border-b border-gray-200">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Información</h3>
          </div>
          <div class="px-6 py-5">
            <dl class="space-y-4">
              <div>
                <dt class="text-sm font-medium text-gray-500">ID de Solicitud</dt>
                <dd class="mt-1 text-sm text-gray-900">#<%= @vacation_request.id %></dd>
              </div>
              <div>
                <a href="<%= user_path(@vacation_request.user) %>" class="text-blue-900 underline">
                  <dt class="text-sm font-medium">Empleado</dt>
                  <dd class="mt-1 text-sm">
                    <%= @vacation_request.user.full_name %>
                    <% if @vacation_request.user.lead %>
                      <div class="text-xs">
                        Líder: <%= @vacation_request.user.lead.full_name %>
                      </div>
                    <% end %>
                  </dd>
                </a>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">País</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= @vacation_request.user.country_name %></dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Fecha de Solicitud</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  <%= @vacation_request.created_at.strftime("%d de %B de %Y") %>
                  <div class="text-xs text-gray-500">
                    <%= @vacation_request.created_at.strftime("%H:%M") %>
                  </div>
                </dd>
              </div>
              <% if @vacation_request.rejected? && @vacation_request.rejected_reason.present? %>
                <div>
                  <dt class="text-sm font-medium text-gray-500">Motivo de Rechazo</dt>
                  <dd class="mt-1 text-sm text-red-600">
                    <%= @vacation_request.rejected_reason %>
                  </dd>
                </div>
              <% end %>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
